pipeline {
  agent any

  // 1ë¶„ë§ˆë‹¤ SCM ë³€ê²½ ê°ì§€ (ì›ì¹˜ ì•Šìœ¼ë©´ ì œê±°í•˜ì„¸ìš”)
  triggers {
    pollSCM('* * * * *')
  }

  options {
    timestamps()
    disableConcurrentBuilds()
  }

  environment {
    // í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ ë¹Œë“œ ì‹¤íŒ¨ë¡œ ì²˜ë¦¬ (ì›í•˜ë©´ true/false ì¡°ì ˆ)
    MAVEN_OPTS = '-Dmaven.test.failure.ignore=false'
  }

  stages {
    stage('Checkout') {
      steps {
        // Pipeline script from SCM ì‚¬ìš© ì‹œ, scm í•¸ë“¤ ì‚¬ìš©ì´ ê°€ì¥ ì•ˆì „
        checkout scm
        // ë˜ëŠ” ëª…ì‹œí˜•:
        // git branch: 'main',
        //     url: 'https://github.com/keungyeupji/source-maven-java-spring-hello-webapp.git'
      }
    }

    stage('Build') {
      steps {
        sh 'mvn -B clean package'
      }
    }

    stage('Archive WAR') {
      steps {
        // ì‚°ì¶œë¬¼(ì›Œ íŒŒì¼) ë³´ê´€
        archiveArtifacts artifacts: 'target/*.war', fingerprint: true
      }
    }

    stage('Deploy to Tomcat') {
      // main ë¸Œëœì¹˜ì¼ ë•Œë§Œ ë°°í¬ (ì›í•˜ë©´ ì œê±°)
      when { branch 'main' }
      steps {
        // Jenkins "Deploy to container" í”ŒëŸ¬ê·¸ì¸ ì‚¬ìš©
        // credentialsId: Jenkinsì— ë“±ë¡í•œ Tomcat Manager ìê²©ì¦ëª… ID
        // url: Tomcat Manager Base URL
        // war: ë°°í¬í•  war íŒŒì¼ ê²½ë¡œ
        // contextPath: í†°ìº£ ì»¨í…ìŠ¤íŠ¸ëª…(ì˜ˆ: hello-world). ë£¨íŠ¸ ë°°í¬ëŠ” '' (ë¹ˆ ë¬¸ìì—´)
        deploy adapters: [
          tomcat9(
            credentialsId: 'tomcat-manager',
            url: 'http://192.168.56.102:8080'
          )
        ],
        war: 'target/hello-world.war',
        contextPath: 'hello-world'
      }
    }
  }

  post {
    success {
      echo 'Build & Deploy successful ğŸ‰'
    }
    failure {
      echo 'Build or Deploy failed âŒ'
    }
    always {
      // í•„ìš” ì‹œ junit ê²°ê³¼, ë¡œê·¸ ì—…ë¡œë“œ ë“± ì¶”ê°€ ê°€ëŠ¥
      // junit 'target/surefire-reports/*.xml'
    }
  }
}

